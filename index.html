<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://www.gstatic.com https://accounts.google.com https://accounts.google.com/gsi; object-src 'none';">
  <title>Google OAuth with Input Fields</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <h1>Google OAuth -- Enter Your Keys</h1>
  <!-- Form to input Client ID and Client Secret -->
  <form id="key-form">
    <label for="client-id">Google Client ID:</label>
    <input type="text" id="client-id" placeholder="Enter Google Client ID" required>
    <br>
    <label for="client-secret">Google Client Secret:</label>
    <input type="text" id="client-secret" placeholder="Enter Google Client Secret" required>
    <br>
    <button type="submit">Start Authentication</button>
  </form>

  <button id="login-button" style="display:none;">Login with Google</button>

  <script>
    // Handle form submission to get keys
    document.getElementById('key-form').addEventListener('submit', function(event) {
      event.preventDefault();

      // Get Client ID and Client Secret from input fields
      const clientId = document.getElementById('client-id').value;
      const clientSecret = document.getElementById('client-secret').value;

      // Check if the inputs are valid
      if (clientId && clientSecret) {
        // Hide the form and show the login button
        document.getElementById('key-form').style.display = 'none';
        document.getElementById('login-button').style.display = 'block';

        // Save the client ID and secret for later use in OAuth flow
        window.GOOGLE_CLIENT_ID = clientId;
        window.GOOGLE_CLIENT_SECRET = clientSecret;

        // Initialize the Google Identity Services client
        google.accounts.id.initialize({
          client_id: clientId,
          callback: handleCredentialResponse
        });

        // Render the Google login button
        google.accounts.id.renderButton(
          document.getElementById("login-button"),
          { theme: "outline", size: "large" }
        );
      } else {
        alert("Please fill in both the Client ID and Client Secret.");
      }
    });

    // Handle the credential response after login
    function handleCredentialResponse(response) {
      // Extract the ID token from the response
      const id_token = response.credential;

      // Exchange the ID token for Access and Refresh tokens
      exchangeIdTokenForTokens(id_token);
    }

    // Function to exchange ID token for Access and Refresh tokens
    function exchangeIdTokenForTokens(id_token) {
      const tokenEndpoint = 'https://oauth2.googleapis.com/token';

      const data = new URLSearchParams();
      data.append('grant_type', 'authorization_code');
      data.append('code', id_token);  // The ID token you got from the login
      data.append('client_id', window.GOOGLE_CLIENT_ID);
      data.append('client_secret', window.GOOGLE_CLIENT_SECRET);
      data.append('redirect_uri', 'YOUR_REDIRECT_URI'); // Set this as appropriate

      fetch(tokenEndpoint, {
        method: 'POST',
        body: data,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      })
      .then(response => response.json())
      .then(data => {
        console.log("Access Token (via exchange): ", data.access_token);
        console.log("Refresh Token (via exchange): ", data.refresh_token);
      })
      .catch(error => console.error('Error exchanging token:', error));
    }
  </script>

</body>
</html>
